<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conformidade de guias ICMS</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg-soft:#f5f6f8;
      --stroke:#e6e8ec;
      --text:#0f1e37;
      --muted:#8a94a6;
      --white:#ffffff;
      --icon-bg:#ffffff;
      --icon-stroke:#dfe3ea;
      --primary:#0d6efd;
      --primary-hover:#0b5ed7;
      --success:#198754;
      --future:#e9ecef;
      --updating:#ffc107;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0;}
    body{
      margin:0; padding:24px; background:#ffffff;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
    }

    .header{
      background:var(--bg-soft);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 1px 0 rgba(15,23,42,.02) inset;
      width:100%;
      max-width:100%;
      position:relative;
    }
    .trail{display:flex; align-items:center; gap:10px; flex-wrap:wrap}

    .chip-icon{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border-radius:8px;
      background:var(--icon-bg);
      border:1px solid var(--icon-stroke);
      font-size:16px;
      color:var(--text);
    }
    .crumb{display:inline-flex; align-items:center; gap:8px}
    .crumb a, .crumb span{color:var(--text); text-decoration:none;}
    .sep{color:var(--muted)}

    .menu-btn{
      width:36px; height:36px; border-radius:8px; background:var(--white);
      border:1px solid var(--icon-stroke);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; transition:transform .06s ease;
    }
    .menu-btn:active{transform:scale(.97)}
    .menu-lines{display:grid; gap:4px}
    .menu-lines span{display:block; width:18px; height:2px; background:var(--text); border-radius:2px}

    .trail span, .trail a{font-size:14px; line-height:1}

    /* Status de atualização */
    .update-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      background: rgba(25, 135, 84, 0.1);
      padding: 6px 10px;
      border-radius: 20px;
      color: var(--success);
      border: 1px solid rgba(25, 135, 84, 0.2);
    }
    .update-status.updating {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
      border-color: rgba(255, 193, 7, 0.2);
    }
    .update-status i {
      font-size: 12px;
    }

    @media (max-width:640px){
      body{padding:16px}
      .header{padding:12px 14px}
      .chip-icon{width:26px; height:26px; font-size:14px}
      .trail span, .trail a{font-size:13px}
      .update-status {
        position: absolute;
        bottom: -28px;
        right: 0;
      }
    }

    /* Dropdown */
    .dropdown{
      position:absolute;
      top:60px;
      right:20px;
      background:var(--white);
      border:1px solid var(--icon-stroke);
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      display:none;
      flex-direction:column;
      min-width:200px;
      z-index:100;
      overflow:hidden;
    }
    .dropdown a{
      padding:10px 14px;
      text-decoration:none;
      color:var(--text);
      font-size:14px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
    }
    .dropdown a:hover{
      background:var(--bg-soft);
    }
    .dropdown hr{
      border:none;
      border-top:1px solid var(--stroke);
      margin:0;
    }
    .dropdown.show{display:flex}
    .dropdown i{font-size:16px}

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.4);
      display:flex; align-items:center; justify-content:center;
      z-index:200;
    }
    .modal-content{
      background:#fff;
      padding:24px;
      border-radius:12px;
      max-width:480px;
      width:90%;
      box-shadow:0 4px 24px rgba(0,0,0,0.15);
      animation:fadeIn .2s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
    .modal h2{
      margin-top:0;
      font-size:20px;
      margin-bottom:20px;
      color:var(--text);
    }

    /* iframe Power BI */
    .dashboard-frame{
      margin-top:20px;
      width:100%;
      height:100vh;
      border:none;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    /* Estilos para a timeline */
    .timeline-container {
      background: var(--bg-soft);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--stroke);
    }
    
    .timeline-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .timeline-header i {
      font-size: 20px;
      color: var(--primary);
    }
    
    .timeline-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    
    .timeline {
      position: relative;
      padding-left: 24px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--stroke);
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
    }
    
    .timeline-item.completed .timeline-dot {
      background: var(--success);
    }
    
    .timeline-item.current .timeline-dot {
      background: var(--primary);
      box-shadow: 0 0 0 2px var(--primary);
    }
    
    .timeline-item.updating .timeline-dot {
      background: var(--updating);
      animation: pulse 1.5s infinite;
    }
    
    .timeline-item.future {
      opacity: 0.6;
    }
    
    .timeline-item.future .timeline-dot {
      background: var(--future);
    }
    
    .timeline-item.future .timeline-time,
    .timeline-item.future .timeline-date {
      color: var(--muted);
    }
    
    .timeline-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--stroke);
      border: 3px solid var(--white);
      box-shadow: 0 0 0 2px var(--stroke);
      position: absolute;
      left: -24px;
      z-index: 2;
      transition: all 0.3s ease;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .timeline-content {
      margin-left: 12px;
      display: flex;
      flex-direction: column;
    }
    
    .timeline-time {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 2px;
    }
    
    .timeline-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Estilos para a seção de informações */
    .info-section {
      background: var(--bg-soft);
      border-radius: 10px;
      padding: 16px;
      border: 1px solid var(--stroke);
    }
    
    .info-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .info-item:last-child {
      margin-bottom: 0;
    }
    
    .info-item i {
      font-size: 18px;
      color: var(--primary);
      margin-top: 2px;
    }
    
    .info-label {
      font-weight: 500;
      font-size: 14px;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    
    .info-value {
      font-size: 14px;
      color: var(--text);
      line-height: 1.4;
    }
    
    .close-btn {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.2s;
      font-family: inherit;
      font-size: 14px;
    }
    
    .close-btn:hover {
      background: var(--primary-hover);
    }
  </style>
</head>
<body>
  <header class="header" aria-label="Cabeçalho de navegação">
    <nav class="trail" aria-label="Breadcrumb">
      <span class="crumb">
        <span class="chip-icon"><i class="bi bi-speedometer2"></i></span>
        <span>Indicadores</span>
      </span>
      <span class="sep">/</span>

      <span class="crumb">
        <span class="chip-icon"><i class="bi bi-bullseye"></i></span>
        <span>Maketing</span>
      </span>
      <span class="sep">/</span>

      <span class="crumb">
        <span class="chip-icon"><i class="bi bi-instagram"></i></span>
        <span>Insights Gerais do Instagram</span>
      </span>
    </nav>

    <div id="updateStatus" class="update-status">
      <i class="bi bi-arrow-clockwise"></i>
      <span>Carregando...</span>
    </div>

    <button class="menu-btn" aria-label="Mais opções" onclick="toggleMenu()">
      <span class="menu-lines" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>

    <div id="dropdownMenu" class="dropdown">
      <a onclick="openModal()">
        <i class="bi bi-info-circle"></i>
        Informações do dashboard
      </a>
      <hr>
      <a href="javascript:history.back()">
        <i class="bi bi-arrow-left"></i>
        Voltar
      </a>
    </div>
  </header>

  <!-- iframe Power BI -->
  <iframe 
    class="dashboard-frame"
    title="Dashboard Power BI"
    src="https://app.powerbi.com/view?r=eyJrIjoiOWU0YWU1ZDEtZDI5Yy00YzgyLWI0MGItYTI3ZTg3ZDcxZTAzIiwidCI6IjYxNDcxMzEwLWJiMDItNGNiZS1hZjY4LTY5NmU5MzE4NjU5ZCJ9&pageName=7536cf0ca3b19a502211" 
    allowFullScreen="true">
  </iframe>

  <!-- Modal -->
  <div id="infoModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Informações do Dashboard</h2>

      <div class="timeline-container">
        <div class="timeline-header">
          <i class="bi bi-clock-history"></i>
          <h3>Cronograma de Atualizações</h3>
        </div>
        
        <div class="timeline" id="updatesTimeline">
          <!-- Os horários serão inseridos dinamicamente pelo JavaScript -->
        </div>
      </div>

      <div class="info-section">
        <div class="info-item">
          <i class="bi bi-calendar"></i>
          <div>
            <span class="info-label">Data:</span>
            <span id="currentDate" class="info-value"></span>
          </div>
        </div>
        <div class="info-item">
          <i class="bi bi-arrow-clockwise"></i>
          <div>
            <span class="info-label">Última atualização:</span>
            <span id="lastUpdate" class="info-value"></span>
          </div>
        </div>
        <div class="info-item">
          <i class="bi bi-person"></i>
          <div>
            <span class="info-label">Autor:</span>
            <span id="author" class="info-value">Equipe Administrativa</span>
          </div>
        </div>
        <div class="info-item">
          <i class="bi bi-card-text"></i>
          <div>
            <span class="info-label">Descrição:</span>
            <span id="description" class="info-value">Dashboard - Acompanhamento de crescimento da conta Instagram: Transcamila_Logistica</span>
          </div>
        </div>
      </div>

      <button type="button" class="close-btn" onclick="closeModal()">Fechar</button>
    </div>
  </div>

  <script>
    // Horários de atualização do dashboard
    const updateTimes = [
      '08:00 AM',
      '09:30 AM',
      '11:00 AM',
      '12:30 PM',
      '02:00 PM',
      '03:30 PM',
      '05:00 PM',
      '06:30 PM'
    ];

    // Variável para armazenar o timeout da próxima atualização
    let nextUpdateTimeout = null;
    let isUpdating = false;

    // Função para formatar a data
    function formatDate(date) {
      const options = { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return date.toLocaleDateString('pt-BR', options);
    }

    // Função para converter horário AM/PM para minutos do dia
    function timeToMinutes(timeStr) {
      const [time, period] = timeStr.split(' ');
      const [hours, minutes] = time.split(':').map(Number);
      
      let totalMinutes = hours * 60 + minutes;
      if (period === 'PM' && hours !== 12) totalMinutes += 12 * 60;
      if (period === 'AM' && hours === 12) totalMinutes -= 12 * 60;
      
      return totalMinutes;
    }

    // Função para obter informações sobre as atualizações
    function getUpdateInfo() {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      
      // Converter todos os horários para minutos
      const updateMinutes = updateTimes.map(timeToMinutes);
      
      // Encontrar o índice da última atualização que já ocorreu
      let lastCompletedIndex = -1;
      for (let i = 0; i < updateMinutes.length; i++) {
        if (updateMinutes[i] <= currentMinutes) {
          lastCompletedIndex = i;
        } else {
          break;
        }
      }
      
      // Determinar se estamos no primeiro horário do dia
      const isFirstUpdateOfDay = currentMinutes < timeToMinutes(updateTimes[0]);
      
      return {
        now,
        currentMinutes,
        updateMinutes,
        lastCompletedIndex,
        isFirstUpdateOfDay
      };
    }

    // Função para simular a atualização do dashboard
    function performDashboardUpdate() {
      isUpdating = true;
      const statusElement = document.getElementById('updateStatus');
      statusElement.innerHTML = '<i class="bi bi-arrow-repeat"></i> <span>Atualizando dados...</span>';
      statusElement.classList.add('updating');
      
      // Simular o tempo de atualização (2-5 segundos)
      const updateTime = 2000 + Math.random() * 3000;
      
      setTimeout(() => {
        // Recarregar o iframe (simulando atualização)
        const iframe = document.querySelector('.dashboard-frame');
        iframe.src = iframe.src; // Força recarregamento
        
        // Atualizar a interface
        isUpdating = false;
        statusElement.classList.remove('updating');
        updateStatus();
        populateTimeline();
        
        // Agendar próxima atualização
        scheduleNextUpdate();
      }, updateTime);
    }

    // Função para agendar a próxima atualização
    function scheduleNextUpdate() {
      // Limpar timeout anterior se existir
      if (nextUpdateTimeout) {
        clearTimeout(nextUpdateTimeout);
      }
      
      const updateInfo = getUpdateInfo();
      const now = updateInfo.now;
      const currentMinutes = updateInfo.currentMinutes;
      
      // Encontrar o próximo horário de atualização
      let nextUpdateIndex = -1;
      for (let i = 0; i < updateInfo.updateMinutes.length; i++) {
        if (updateInfo.updateMinutes[i] > currentMinutes) {
          nextUpdateIndex = i;
          break;
        }
      }
      
      // Se não há mais atualizações hoje, agendar para o primeiro horário do próximo dia
      if (nextUpdateIndex === -1) {
        const nextDay = new Date(now);
        nextDay.setDate(nextDay.getDate() + 1);
        nextDay.setHours(8, 0, 0, 0); // Primeiro horário (08:00 AM)
        
        const timeUntilNextDay = nextDay.getTime() - now.getTime();
        nextUpdateTimeout = setTimeout(performDashboardUpdate, timeUntilNextDay);
        
        console.log('Próxima atualização agendada para amanhã às 08:00 AM');
        return;
      }
      
      // Calcular o tempo até a próxima atualização
      const nextUpdateTime = new Date(now);
      const nextUpdateMinutes = updateInfo.updateMinutes[nextUpdateIndex];
      nextUpdateTime.setHours(Math.floor(nextUpdateMinutes / 60), nextUpdateMinutes % 60, 0, 0);
      
      const timeUntilNextUpdate = nextUpdateTime.getTime() - now.getTime();
      
      // Agendar a atualização
      nextUpdateTimeout = setTimeout(performDashboardUpdate, timeUntilNextUpdate);
      
      console.log(`Próxima atualização agendada para ${updateTimes[nextUpdateIndex]}`);
    }

    // Atualizar o status no cabeçalho
    function updateStatus() {
      const updateInfo = getUpdateInfo();
      const statusElement = document.getElementById('updateStatus');
      
      // Formatar a data atual
      document.getElementById('currentDate').textContent = formatDate(updateInfo.now);
      
      // Determinar a última atualização
      let lastUpdateTime, lastUpdateDate;
      
      if (updateInfo.lastCompletedIndex >= 0) {
        lastUpdateTime = updateTimes[updateInfo.lastCompletedIndex];
        lastUpdateDate = 'Hoje';
      } else {
        // Se nenhuma atualização ocorreu hoje, usar a última de ontem
        lastUpdateTime = updateTimes[updateTimes.length - 1];
        const yesterday = new Date(updateInfo.now);
        yesterday.setDate(yesterday.getDate() - 1);
        lastUpdateDate = yesterday.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
      }
      
      // Atualizar o status
      statusElement.innerHTML = `
        <i class="bi bi-arrow-clockwise"></i>
        <span>Atualizado ${lastUpdateTime} (${lastUpdateDate})</span>
      `;
      
      // Atualizar no modal também
      document.getElementById('lastUpdate').textContent = 
        `${lastUpdateTime} - ${lastUpdateDate}`;
    }

    // Função para popular a timeline com estado das atualizações
    function populateTimeline() {
      const updateInfo = getUpdateInfo();
      const timeline = document.getElementById('updatesTimeline');
      timeline.innerHTML = '';
      
      updateTimes.forEach((time, index) => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        // Determinar o estado deste horário
        const timeMinutes = updateInfo.updateMinutes[index];
        let state = '';
        
        if (index === updateInfo.lastCompletedIndex) {
          state = 'current'; // Última atualização completada
        } else if (index < updateInfo.lastCompletedIndex) {
          state = 'completed'; // Já ocorreu
        } else if (index > updateInfo.lastCompletedIndex) {
          state = 'future'; // Ainda vai ocorrer
        }
        
        // Se for antes do primeiro horário do dia, todos são "future"
        if (updateInfo.isFirstUpdateOfDay) {
          state = 'future';
        }
        
        // Se está atualizando neste momento
        if (state === 'current' && isUpdating) {
          state = 'updating';
        }
        
        item.classList.add(state);
        
        // Adicionar tooltip para o horário atual
        let tooltip = '';
        if (state === 'current') {
          tooltip = 'Última atualização';
        } else if (state === 'completed') {
          tooltip = 'Atualização concluída';
        } else if (state === 'updating') {
          tooltip = 'Atualizando agora...';
        } else {
          tooltip = 'Atualização pendente';
        }
        
        item.innerHTML = `
          <div class="timeline-dot" title="${tooltip}"></div>
          <div class="timeline-content">
            <span class="timeline-time">${time}</span>
            <span class="timeline-date">${state === 'current' ? 'Última atualização' : 
                                      state === 'updating' ? 'Atualizando agora' : 
                                      'Atualização diária'}</span>
          </div>
        `;
        
        timeline.appendChild(item);
      });
    }

    function toggleMenu(){
      document.getElementById('dropdownMenu').classList.toggle('show');
    }
    
    document.addEventListener('click', function(e){
      const menuBtn = document.querySelector('.menu-btn');
      const dropdown = document.getElementById('dropdownMenu');
      if(!menuBtn.contains(e.target) && !dropdown.contains(e.target)){
        dropdown.classList.remove('show');
      }
    });

    function openModal(){
      document.getElementById('infoModal').style.display = 'flex';
      document.getElementById('dropdownMenu').classList.remove('show');
      populateTimeline();
      updateStatus();
    }
    
    function closeModal(){
      document.getElementById('infoModal').style.display = 'none';
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      updateStatus();
      populateTimeline();
      scheduleNextUpdate();
      
      // Atualizar a interface a cada minuto para manter as informações corretas
      setInterval(() => {
        if (!isUpdating) {
          updateStatus();
          populateTimeline();
        }
      }, 60000);
    });
  </script>
</body>
</html>