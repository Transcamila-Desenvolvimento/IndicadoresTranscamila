{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <div class="sidebar-header">
                <img src="{% static 'Transcamila.png' %}" alt="Logo Transcamila" class="logo">
            </div>
           
            <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 20px;">
            <ul class="nav nav-pills flex-column mb-auto" style="padding: 0 12px;">
            <li>
            <a href="#" class="nav-link">
            <i class="bi bi-bar-chart-line"></i>
            Indicadores
            </a>
            <ul class="nav flex-column nav-submenu mt-2">
                {% if user.is_authenticated and user.username == 'junior.quintino' %}
                <li><a href="#" class="nav-link active" onclick="showContent('faturamento')"><i class="bi bi-cash-coin"></i> Faturamento</a></li>
                <li><a href="#" class="nav-link" onclick="showContent('financeiro')"><i class="bi bi-bank"></i> Financeiro</a></li>
                {% else %}
                <li><a href="#" class="nav-link active" onclick="showContent('faturamento')"><i class="bi bi-cash-coin"></i> Faturamento</a></li>
                <li><a href="#" class="nav-link" onclick="showContent('provisao')"><i class="bi bi-receipt"></i> Provisão</a></li>
                <li><a href="#" class="nav-link" onclick="showContent('marketing')"><i class="bi bi-bullseye"></i> Marketing</a></li>
                <li><a href="#" class="nav-link" onclick="showContent('rh')"><i class="bi bi-people"></i> RH</a></li>
                <li><a href="#" class="nav-link" onclick="showContent('financeiro')"><i class="bi bi-bank"></i> Financeiro</a></li>
                {% if user.is_authenticated and user.is_staff or user.is_superuser %}
                    <li><a href="#" class="nav-link" onclick="showContent('saldos-bancarios')"><i class="bi bi-currency-dollar"></i> Saldos Bancários</a></li>
                {% endif %}
                {% if user.is_authenticated and user.username == 'miguel.ribeiro' %}
                    <li><a href="#" class="nav-link" onclick="showContent('dashboard-ctes')"><i class="bi bi-truck"></i> CT-es emitidos</a></li>
                {% endif %}
            {% endif %}
        </ul>
    </li>
</ul>
        </div>
       
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name">
                    {% if user.first_name and user.last_name %}
                        {{ user.first_name }} {{ user.last_name }}
                    {% else %}
                        {{ user.username }}
                    {% endif %}
                </div>
                <div class="user-role">
                    {% if user.is_superuser %}
                        Administrador
                    {% else %}
                        Usuário
                    {% endif %}
                </div>
            </div>
            <a href="{% url 'logout' %}" class="btn btn-sm btn-logout">
                <i class="bi bi-box-arrow-right me-1"></i> Encerrar Sessão
            </a>
        </div>
    </div>

    <!-- Conteúdo principal -->
    <div class="main-content">

        <!-- Área de Faturamento -->
        <div id="faturamento" class="content-area active">
            <div class="welcome-bar">
                <div class="welcome-text">
                    <h2>Indicadores de Faturamento</h2>
                    <p>Monitore e analise os principais KPIs de faturamento</p>
                </div>
                <div class="date-display">
                    <i class="bi bi-calendar3"></i>
                    <span id="current-date"></span>
                </div>
            </div>
           
            <h2 class="section-title"></h2>
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-currency-dollar"></i>
                        <h3>Analise de Faturados x A faturar</h3>
                    </div>
                    <div class="card-body">
                        <p>Exibe o faturamento já concluído e o que ainda está pendente com status de prazo, junto das baixas registradas.</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:cte' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-box-seam"></i>
                        <h3>Volume de CTE's Recebidos diariamente</h3>
                    </div>
                    <div class="card-body">
                        <p>Volume de CTE's recebidos diariamente, entregues pela logística e malote (Média de dias entre emissão e recebimento).</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:cterecebidos' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-currency-dollar"></i>
                        <h3>Analise de Vencidos X a vencer</h3>
                    </div>
                    <div class="card-body">
                        <p>Mostra a relação entre o que já está vencido e o que ainda vai vencer nos recebíveis de cada cliente. Inclui o histórico de inadimplência e a média de dias em atraso</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:inadimplencia' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Área de Provisão -->
        <div id="provisao" class="content-area">
            <div class="welcome-bar">
                <div class="welcome-text">
                    <h2>Indicadores de Provisão</h2>
                    <p>Monitore e analise os principais KPIs de provisão da Transcamila</p>
                </div>
                <div class="date-display">
                    <i class="bi bi-calendar3"></i>
                    <span id="current-date-provisao"></span>
                </div>
            </div>
            <h2 class="section-title"></h2>
           
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-person-heart"></i>
                        <h2>Feedback de Clientes</h2>
                    </div>
                    <div class="card-body">
                        <p>Dashboard de pesquisa de satisfação que monitora a experiência do cliente, incluindo métricas sobre prazo de entrega, condição da mercadoria, apresentação do motorista, estado do veículo e qualidade do atendimento recebido</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:avaliacaodeentregas' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-text"></i>
                        <h3>Lançamentos de Notas Fiscais</h3>
                    </div>
                    <div class="card-body">
                        <p>Acompanhamento dos lançamentos de notas fiscais, incluindo indicadores de despesas por filial, correções e registros diários.</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:lancamento' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Marketing -->
        <div id="marketing" class="content-area">
            <div class="welcome-bar">
                <div class="welcome-text">
                    <h2>Indicadores de Marketing</h2>
                    <p>Monitore e analise os principais KPIs de marketing</p>
                </div>
                <div class="date-display">
                    <i class="bi bi-calendar3"></i>
                    <span id="current-date-marketing"></span>
                </div>
            </div>
            <h2 class="section-title"></h2>
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-instagram"></i>
                        <h3>Insights Gerais do Instagram</h3>
                    </div>
                    <div class="card-body">
                        <p>Monitora o desempenho geral da conta do Instagram, incluindo métricas de engajamento, alcance, impressões e crescimento de seguidores</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:insightsinstagram' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-journal"></i>
                        <h3>Insights Transcamila News</h3>
                    </div>
                    <div class="card-body">
                        <p>Analise o desempenho das postagens do Transcamila News, incluindo alcance, engajamento e interações dos leitores.</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:transcamilanews' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Área de RH -->
        <div id="rh" class="content-area">
            <div class="welcome-bar">
                <div class="welcome-text">
                    <h2>Indicadores de RH</h2>
                    <p>Monitore e analise os principais KPIs de recursos humanos da Transcamila</p>
                </div>
                <div class="date-display">
                    <i class="bi bi-calendar3"></i>
                    <span id="current-date-rh"></span>
                </div>
            </div>
            <h2 class="section-title"></h2>
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-people-fill"></i>
                        <h3>Rotatividade</h3>
                    </div>
                    <div class="card-body">
                        <p>Acompanhamento mensal e anual de admissões, desligamentos e taxa de rotatividade</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:recrutamento' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
              
                {% if user.is_authenticated and user.is_staff or user.is_superuser %}
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-person-fill-check"></i>
                        <h3>Jornada e Frequência</h3>
                    </div>
                    <div class="card-body">
                        <p>Analise de marcações manuais dos colaboradores</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-confidential" style="background-color: #F3C550; color: #815800;">Confidencial</span>
                        <a href="{% url 'dashboard:jornada' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                {% endif %}
               
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-people-fill"></i>
                        <h3>Distribuição da força de trabalho</h3>
                    </div>
                    <div class="card-body">
                        <p>Análise de colaboradores por idade, sexo e escolaridade, segmentada por filial, cargo e líder responsável</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:força' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                {% if user.is_authenticated and user.is_staff or user.is_superuser %}
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-people-fill"></i>
                        <h3>Evolução Salarial (Em breve)</h3>
                    </div>
                    <div class="card-body">
                        <p>Acompanhe a variação média dos salários ao longo do tempo, identificando tendências de crescimento, ajustes e períodos de estabilidade na remuneração dos colaboradores.</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-confidential" style="background-color: #F3C550; color: #815800;">Confidencial</span>
                        <a href="#" class="btn btn-primary">Em breve</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
       
        <!-- Área de Financeiro -->
        <div id="financeiro" class="content-area">
            <div class="welcome-bar">
                <div class="welcome-text">
                    <h2>Indicadores Financeiros</h2>
                    <p>Monitore e analise os principais KPIs financeiros</p>
                </div>
                <div class="date-display">
                    <i class="bi bi-calendar3"></i>
                    <span id="current-date-financeiro"></span>
                </div>
            </div>
            <h2 class="section-title"></h2>
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-file-text"></i>
                        <h3>Frequencia de status de OPs</h3>
                    </div>
                    <div class="card-body">
                        <p>Frequencia de status de OPs: Finalizadas vs. Não Finalizadas</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:op' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-file-text"></i>
                        <h3>Conformidade de Guias de ICMS</h3>
                    </div>
                    <div class="card-body">
                        <p>Frequência de guias de ICMS corretas e incorretas</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:icms' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="card-header">
                        <i class="bi bi-file-text"></i>
                        <h3>Pagamentos Sem Lançamento</h3>
                    </div>
                    <div class="card-body">
                        <p>Frequência de pagamentos realizados que não possuem registro correspondente no sistema (Sem lançamento de nota fiscal)</p>
                    </div>
                    <div class="card-footer">
                        <span class="status-badge status-completed" style="background-color: #1089c3; color: white;">Liberado</span>
                        <a href="{% url 'dashboard:nf' %}" class="btn btn-primary">Acessar</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Saldos Bancários -->
        <div id="saldos-bancarios" class="content-area">
            <div class="dashboard" style="padding: 20px; background: #f5f7fa; border-radius: 12px; margin-top: 20px;">
                <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0;">
                    <h1 style="font-weight: 600; margin: 0;">Saldos bancários</h1>
                    <div class="date" id="current-time" style="background: #148ec4; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px;">Carregando...</div>
                </div>
                <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="card highlight" style="background: linear-gradient(135deg, #1b5e99, #148ec4); color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="card-title" style="font-size: 14px; color: rgba(255,255,255,.8);">SALDO BANCO</div>
                        <div class="card-value" id="saldo" style="font-size: 24px; font-weight: 700; margin: 8px 0; color: white;">R$ 0,00</div>
                        <div class="card-description" style="font-size: 12px; color: rgba(255,255,255,.8);">Saldo total em contas</div>
                    </div>
                    <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="card-title" style="font-size: 14px; color: #95a5a6;">LIMITE</div>
                        <div class="card-value" id="limite" style="font-size: 24px; font-weight: 700; margin: 8px 0; color: #2c3e50;">R$ 0,00</div>
                        <div class="card-description" style="font-size: 12px; color: #95a5a6;">Limite de crédito disponível</div>
                    </div>
                    <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="card-title" style="font-size: 14px; color: #95a5a6;">TOTAL EM APLICAÇÃO</div>
                        <div class="card-value" id="cheque" style="font-size: 24px; font-weight: 700; margin: 8px 0; color: #2c3e50;">R$ 0,00</div>
                        <div class="card-description" style="font-size: 12px; color: #95a5a6;">Aplicações</div>
                    </div>
                    <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="card-title" style="font-size: 14px; color: #95a5a6;">DISPONÍVEL</div>
                        <div class="card-value" id="disponivel" style="font-size: 24px; font-weight: 700; margin: 8px 0; color: #2c3e50;">R$ 0,00</div>
                        <div class="card-description" style="font-size: 12px; color: #95a5a6;">Valor total disponível</div>
                    </div>
                </div>
                <h2 style="margin: 30px 0 20px;">Contas Correntes</h2>
                <div class="bank-accounts" id="banks" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 20px;"></div>
                <div class="status" id="status" style="text-align: right; font-size: 12px; margin-top: 10px;"><span class="loading" style="color: #148ec4;">Carregando dados...</span></div>
            </div>

            <!-- SCRIPT DO SALDOS -->
            <script>
                (function() {
                    const SHEET_ID = '1t_6NFKIgGSIB9qLp3s4ikXcKS8MgV37aiylYSzfjVmo';
                    const GID = '0';
                    let lastData = null;
                    const bankLogos = {
                        'Itaú': 'https://res.cloudinary.com/dnmppxebg/image/upload/v1761795926/Ita%C3%BA_hdct8j.png',
                        'Santander': 'https://res.cloudinary.com/dnmppxebg/image/upload/v1761795925/santander_opahkg.jpg',
                        'Bradesco': 'https://res.cloudinary.com/dnmppxebg/image/upload/v1761795925/Bradesco_oeunlq.jpg',
                        'Banco do Brasil': 'https://res.cloudinary.com/dnmppxebg/image/upload/v1761795925/Banco_do_Brasil_ypj3hp.jpg',
                        'Banco Daycoval': 'https://res.cloudinary.com/dnmppxebg/image/upload/v1761795925/Daycoval_lw8821.png'
                    };
                    const fallbackSvg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2RkZCIgcng9IjEwIi8+PHRleHQgeD0iNTAlIiB5PSI1NSUiIGZvbnQtc2l6ZT0iNDAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPj88L3RleHQ+PC9zdmc+';

                    function format(v) {
                        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
                    }

                    function parseCurrency(cell) {
                        if (!cell) return 0;
                        if (typeof cell.v === 'number') return cell.v;
                        let str = cell.f && typeof cell.f === 'string' ? cell.f : (typeof cell.v === 'string' ? cell.v : '');
                        return parseFloat(str.replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.')) || 0;
                    }

                    function getYesterday() {
                        const d = new Date();
                        d.setDate(d.getDate() - 1);
                        return d.toLocaleDateString('pt-BR');
                    }

                    async function loadData() {
                        const status = document.getElementById('status');
                        status.innerHTML = '<span class="loading" style="color: #148ec4;">Carregando...</span>';
                        try {
                            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&t=${Date.now()}`;
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Falha na rede');
                            const text = await response.text();
                            const jsonText = text.substring(47, text.length - 2);
                            const json = JSON.parse(jsonText);
                            const rows = json.table.rows;

                            const data = { banks: {}, total: { s: 0, l: 0, c: 0, d: 0, aplic: 0 } };
                            let currentBank = null;

                            for (let i = 0; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row.c || !row.c[0]) continue;
                                const cellA = row.c[0].v?.toString().trim();
                                if (!cellA || cellA === getYesterday() || cellA === 'TOTAL') continue;

                                if (!cellA.match(/C[\/\\]C/i)) {
                                    currentBank = cellA;
                                    if (!data.banks[currentBank]) data.banks[currentBank] = { acc: [], tot: { s: 0, l: 0, c: 0, d: 0, aplic: 0 } };
                                    continue;
                                }

                                let contaRaw = cellA.replace(/^C[\/\\]C\s*n?[°º]?\s*[:\-]?\s*/gi, '').trim();
                                contaRaw = contaRaw.replace(/-\s*\(\s*APLIC\s*\)$/i, ' (APLIC)');

                                const s = parseCurrency(row.c[1]);
                                const l = parseCurrency(row.c[2]);
                                const c = row.c[3] ? parseCurrency(row.c[3]) : 0;
                                const d = parseCurrency(row.c[4]) || (s + l - c);

                                const isAplic = /\(APLIC\)$/i.test(contaRaw);
                                const conta = contaRaw;

                                const acc = { conta, s, l, c, d, isAplic };
                                data.banks[currentBank].acc.push(acc);

                                if (isAplic) {
                                    data.banks[currentBank].tot.aplic += s;
                                    data.total.aplic += s;
                                } else {
                                    data.banks[currentBank].tot.s += s;
                                    data.total.s += s;
                                }

                                data.banks[currentBank].tot.l += l;
                                data.banks[currentBank].tot.c += c;
                                data.banks[currentBank].tot.d += d;

                                data.total.l += l;
                                data.total.c += c;
                                data.total.d += d;
                            }

                            if (Object.keys(data.banks).length === 0) throw new Error('Nenhum dado');
                            lastData = data;
                            render(data);
                            status.textContent = `Atualizado: ${new Date().toLocaleTimeString('pt-BR')}`;
                        } catch (err) {
                            console.error('Erro:', err);
                            status.innerHTML = `<span class="error" style="color: #e74c3c;">Erro: ${err.message}</span>`;
                            if (lastData) {
                                render(lastData);
                                status.innerHTML += ' <small>(dados antigos)</small>';
                            }
                        }
                    }

                    function render(data) {
                        document.getElementById('current-time').textContent = getYesterday();
                        document.getElementById('saldo').textContent = format(data.total.s);
                        document.getElementById('limite').textContent = format(data.total.l);
                        document.getElementById('cheque').textContent = format(data.total.aplic);
                        document.getElementById('disponivel').textContent = format(data.total.s + data.total.aplic + data.total.l - data.total.c);

                        const container = document.getElementById('banks');
                        container.innerHTML = '';
                        const order = ['Itaú', 'Santander', 'Bradesco', 'Banco do Brasil', 'Banco Daycoval'];

                        order.forEach(name => {
                            const bank = data.banks[name];
                            if (!bank || bank.acc.length === 0) return;
                            const logo = bankLogos[name] || fallbackSvg;

                            let html = `
                            <div class="bank-card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow-x: auto;">
                                <div class="bank-header" style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;">
                                    <div class="bank-logo" style="width: 40px; height: 40px; margin-right: 12px; background: #eee; border-radius: 8px; overflow: hidden;">
                                        <img src="${logo}" alt="${name}" onerror="this.src='${fallbackSvg}';" style="width: 100%; height: 100%; object-fit: contain;">
                                    </div>
                                    <div class="bank-name" style="font-weight: 600; font-size: 18px;">${name}</div>
                                </div>
                                <table class="account-table" style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left; padding: 10px 8px; font-size: 12px; color: #95a5a6; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">CONTA</th>
                                            <th style="text-align: left; padding: 10px 8px; font-size: 12px; color: #95a5a6; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">SALDO</th>
                                            <th style="text-align: left; padding: 10px 8px; font-size: 12px; color: #95a5a6; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">LIMITE</th>
                                            <th style="text-align: left; padding: 10px 8px; font-size: 12px; color: #95a5a6; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">DISPONÍVEL</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                            bank.acc.forEach(acc => {
                                const saldoStyle = acc.isAplic 
                                    ? `<span style="color: #27ae60; font-weight: 600;">${format(acc.s)} </span>` 
                                    : format(acc.s);
                                html += `
                                    <tr>
                                        <td style="padding: 12px 8px; border-bottom: 1px solid #f5f5f5; font-size: 14px; white-space: nowrap;">${acc.conta}</td>
                                        <td style="padding: 12px 8px; border-bottom: 1px solid #f5f5f5; font-size: 14px; font-weight: 600; color: #2c3e50;">${saldoStyle}</td>
                                        <td style="padding: 12px 8px; border-bottom: 1px solid #f5f5f5; font-size: 14px; font-weight: 600; color: #2c3e50;">${format(acc.l)}</td>
                                        <td style="padding: 12px 8px; border-bottom: 1px solid #f5f5f5; font-size: 14px; font-weight: 600; color: #2c3e50;">${format(acc.d)}</td>
                                    </tr>`;
                            });

                            const totalSaldo = bank.tot.s + bank.tot.aplic;
                            html += `
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td style="font-weight:700; padding: 12px 8px; background: #f1f5f9; border-top: 2px solid #148ec4; color: #2c3e50;">TOTAL</td>
                                            <td style="padding: 12px 8px; background: #f1f5f9; border-top: 2px solid #148ec4; color: #2c3e50;">${format(totalSaldo)}</td>
                                            <td style="padding: 12px 8px; background: #f1f5f9; border-top: 2px solid #148ec4; color: #2c3e50;">${format(bank.tot.l)}</td>
                                            <td style="padding: 12px 8px; background: #f1f5f9; border-top: 2px solid #148ec4; color: #2c3e50;">${format(bank.tot.d)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>`;
                            container.innerHTML += html;
                        });
                    }

                    setInterval(loadData, 15000);
                    loadData();
                })();
            </script>
        </div>

        <!-- DASHBOARD DE CTEs (COM ABAS SIMPLES SEM BOOTSTRAP) -->
        <div id="dashboard-ctes" class="content-area">
            <div class="p-4">
                <!-- Cabeçalho -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="section-title mb-0">Dashboard de CTEs</h2>
                    <div class="date-display">
                        <i class="bi bi-calendar3 me-2"></i>
                        <span id="ctes-current-time">Carregando...</span>
                    </div>
                </div>

                <!-- FILTROS -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <form id="form-filtros" class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Ano</label>
                                <select class="form-select form-select-sm" id="filter-ano"></select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Mês</label>
                                <select class="form-select form-select-sm" id="filter-mes">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Dia</label>
                                <input type="date" class="form-control form-control-sm" id="filter-dia">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Período</label>
                                <input type="text" class="form-control form-control-sm" id="filter-periodo" placeholder="01/03 - 10/03">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Operação</label>
                                <select class="form-select form-select-sm" id="filter-operacao">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Tomador</label>
                                <select class="form-select form-select-sm" id="filter-tomador">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-muted">Granularidade</label>
                                <select class="form-select form-select-sm" id="granularidade">
                                    <option value="dia">Dia</option>
                                    <option value="semana">Semana</option>
                                    <option value="mes">Mês</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-primary w-100" id="aplicar-filtros">
                                    <i class="bi bi-funnel me-1"></i> Filtrar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- BOTÕES PERSONALIZADOS PARA ABAS (SEM BOOTSTRAP) -->
                <div class="custom-tabs mb-4">
                    <button class="tab-btn active" data-tab="aba-visao-geral">
                        <i class="bi bi-graph-up"></i> Visão Geral
                    </button>
                    <button class="tab-btn" data-tab="aba-composicao">
                        <i class="bi bi-pie-chart"></i> Composição
                    </button>
                    <button class="tab-btn" data-tab="aba-analitico">
                        <i class="bi bi-table"></i> Analítico
                    </button>
                </div>

                <!-- CONTEÚDO DAS ABAS -->
                <div class="tab-content">
                    <!-- ABA 1: VISÃO GERAL -->
                    <div class="tab-pane active" id="aba-visao-geral">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="indicator-card">
                                    <div class="card-header" style="background: var(--gradient-primary);">
                                        <i class="bi bi-file-text"></i>
                                        <h3>CTEs Emitidos</h3>
                                    </div>
                                    <div class="card-body">
                                        <h2 class="mb-0" id="card-ctes">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="indicator-card">
                                    <div class="card-header" style="background: var(--gradient-secondary);">
                                        <i class="bi bi-currency-dollar"></i>
                                        <h3>Valor Faturado</h3>
                                    </div>
                                    <div class="card-body">
                                        <h2 class="mb-0" id="card-valor">R$ 0,00</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="indicator-card">
                                    <div class="card-header" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                                        <i class="bi bi-box"></i>
                                        <h3>Volume</h3>
                                    </div>
                                    <div class="card-body">
                                        <h2 class="mb-0" id="card-volume">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="indicator-card">
                                    <div class="card-header" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                                        <i class="bi bi-truck"></i>
                                        <h3>Peso</h3>
                                    </div>
                                    <div class="card-body">
                                        <h2 class="mb-0" id="card-peso">0 kg</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Valor Faturado e CTEs por Período</h5>
                                <canvas id="chart-visao-geral" height="100"></canvas>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Últimos CTEs Emitidos</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="tabela-ultimos-ctes">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Nº CTE</th>
                                                <th>Origem → Destino</th>
                                                <th>Tomador</th>
                                                <th class="text-end">Frete</th>
                                                <th class="text-center">Emissão</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 2: COMPOSIÇÃO -->
                    <div class="tab-pane" id="aba-composicao">
                        <div class="row g-3 mb-4">
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #1089c3;">
                                        <i class="bi bi-cash"></i>
                                        <h3>Valor Total</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-valor-faturado">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #26A69A;">
                                        <i class="bi bi-truck"></i>
                                        <h3>Frete Peso</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-frete-peso">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #FF9800;">
                                        <i class="bi bi-shield"></i>
                                        <h3>Ad Valorem</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-advalorem">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #F44336;">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <h3>GRIS</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-gris">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #9C27B0;">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <h3>ICMS</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-icms">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="indicator-card">
                                    <div class="card-header text-white" style="background: #607D8B;">
                                        <i class="bi bi-signpost"></i>
                                        <h3>Pedágio</h3>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="mb-0" id="comp-pedagio">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Composição do Frete</h5>
                                <canvas id="chart-composicao" height="120"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 3: ANALÍTICO -->
                    <div class="tab-pane" id="aba-analitico">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Por Operação</h5>
                                        <canvas id="chart-por-operacao"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Por Tomador</h5>
                                        <canvas id="chart-por-tomador"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mt-4">
                            <div class="card-body">
                                <h5 class="card-title">Resumo Analítico</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover" id="tabela-analitico">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Grupo</th>
                                                <th>CTEs</th>
                                                <th>Valor</th>
                                                <th>Peso</th>
                                                <th>Volume</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <small class="text-muted" id="ctes-status">Carregando dados...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS DAS ABAS PERSONALIZADAS -->
<style>
.custom-tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.tab-btn {
    background: none;
    border: none;
    padding: 12px 20px;
    font-size: 15px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tab-btn:hover {
    color: #1089c3;
}

.tab-btn.active {
    color: #1089c3;
    border-bottom-color: #1089c3;
    font-weight: 600;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}
</style>

<!-- Chart.js + Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>

<script>
    // === SISTEMA DE ABAS SEM BOOTSTRAP ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-tab');

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            btn.classList.add('active');
            const pane = document.getElementById(target);
            if (pane) pane.classList.add('active');
        });
    });

    // === SCRIPT DO DASHBOARD DE CTEs ===
    (function () {
        const API_URL = "{% url 'dashboard:api_ctes_dashboard' %}".replace(/\/$/, '');
        let charts = {};

        const filtros = {
            ano: new Date().getFullYear(),
            mes: new Date().getMonth() + 1,
            dia: '',
            periodo: '',
            operacao: '',
            tomador: '',
            granularidade: 'dia'
        };

        function initFiltros() {
            const ano = new Date().getFullYear();
            const select = document.getElementById('filter-ano');
            for (let y = ano - 2; y <= ano + 1; y++) {
                const opt = new Option(y, y, y === ano, y === ano);
                select.add(opt);
            }
            document.getElementById('filter-mes').value = new Date().getMonth() + 1;
        }

        document.getElementById('aplicar-filtros').onclick = () => {
            ['ano', 'mes', 'dia', 'periodo', 'operacao', 'tomador', 'granularidade'].forEach(k => {
                const el = document.getElementById('filter-' + k);
                if (el) filtros[k] = el.value || '';
            });
            carregarDados();
        };

        async function carregarDados() {
            const status = document.getElementById('ctes-status');
            status.innerHTML = '<small class="text-primary"><i class="bi bi-arrow-clockwise"></i> Carregando...</small>';

            try {
                const params = new URLSearchParams(filtros);
                const url = `${API_URL}?${params}`;
                const res = await fetch(url, {
                    credentials: 'same-origin',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    throw new Error("Resposta inválida do servidor");
                }

                const data = await res.json();

                document.getElementById('card-ctes').textContent = data.totais?.ctes || 0;
                document.getElementById('card-valor').textContent = formatCurrency(data.totais?.valor_faturado || 0);
                document.getElementById('card-volume').textContent = data.totais?.volume || 0;
                document.getElementById('card-peso').textContent = `${(data.totais?.peso || 0).toLocaleString('pt-BR')} kg`;

                const compMap = {
                    valor_faturado: 'comp-valor-faturado',
                    frete_peso: 'comp-frete-peso',
                    advalorem: 'comp-advalorem',
                    gerenciamento_risco: 'comp-gris',
                    icms: 'comp-icms',
                    pedagio: 'comp-pedagio'
                };
                Object.keys(compMap).forEach(key => {
                    const id = compMap[key];
                    const el = document.getElementById(id);
                    if (el) el.textContent = formatCurrency(data.composicao?.[key] || 0);
                });

                ['operacao', 'tomador'].forEach(f => {
                    const select = document.getElementById('filter-' + f);
                    const current = select.value;
                    select.innerHTML = '<option value="">Todos</option>';
                    (data[f + 's'] || []).forEach(item => {
                        const opt = new Option(item, item, false, item === current);
                        select.add(opt);
                    });
                });

                updateChart('chart-visao-geral', createBarLineChart(data.serie_temporal || []));
                updateChart('chart-composicao', createDoughnutChart(data.composicao || {}));
                updateChart('chart-por-operacao', createHorizontalBar(data.por_operacao || [], 'Operação'));
                updateChart('chart-por-tomador', createHorizontalBar(data.por_tomador || [], 'Tomador'));
                updateTable('tabela-ultimos-ctes', data.ultimos_ctes || []);
                updateTable('tabela-analitico', data.resumo_analitico || []);

                status.innerHTML = `<small class="text-success"><i class="bi bi-check-circle"></i> Atualizado: ${new Date().toLocaleTimeString()}</small>`;
                document.getElementById('ctes-current-time').textContent = new Date().toLocaleDateString('pt-BR');

                // Restaura aba ativa
                const activeTab = document.querySelector('.tab-btn.active')?.getAttribute('data-tab');
                if (activeTab) {
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    document.getElementById(activeTab)?.classList.add('active');
                }

            } catch (e) {
                console.error("Erro no dashboard CTEs:", e);
                status.innerHTML = `<small class="text-danger"><i class="bi  bi-exclamation-triangle"></i> Erro: ${e.message}</small>`;
            }
        }

        function formatCurrency(v) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
        }

        function updateChart(id, config) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            const chartCtx = ctx.getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(chartCtx, config);
        }

        function createBarLineChart(data) {
            return {
                type: 'bar',
                data: {
                    labels: data.map(d => d.label || ''),
                    datasets: [
                        {
                            label: 'Valor Faturado',
                            data: data.map(d => d.valor_faturado || 0),
                            backgroundColor: 'rgba(16, 137, 195, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'CTEs',
                            data: data.map(d => d.ctes || 0),
                            type: 'line',
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true },
                        y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } }
                    }
                }
            };
        }

        function createDoughnutChart(comp) {
            const values = [comp.frete_peso, comp.advalorem, comp.gerenciamento_risco, comp.icms, comp.pedagio].map(v => v || 0);
            return {
                type: 'doughnut',
                data: {
                    labels: ['Frete Peso', 'Ad Valorem', 'GRIS', 'ICMS', 'Pedágio'],
                    datasets: [{ data: values, backgroundColor: ['#1089c3', '#26A69A', '#FF9800', '#F44336', '#9C27B0'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            };
        }

        function createHorizontalBar(data, label) {
            return {
                type: 'bar',
                data: {
                    labels: data.map(d => d.grupo || ''),
                    datasets: [{
                        label,
                        data: data.map(d => d.valor || 0),
                        backgroundColor: label === 'Operação' ? '#1089c3' : '#26A69A'
                    }]
                },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
            };
        }

        function updateTable(id, data) {
            const tbody = document.querySelector(`#${id} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            data.slice(0, id.includes('ultimos') ? 10 : data.length).forEach(item => {
                const tr = document.createElement('tr');
                if (id.includes('ultimos')) {
                    tr.innerHTML = `
                        <td><code>${item.numero_cte || '—'}</code></td>
                        <td>${item.origem_destino || '—'}</td>
                        <td title="${item.tomador_info || ''}">${item.tomador_info || '—'}</td>
                        <td class="text-end fw-bold">${formatCurrency(item.valor_frete || 0)}</td>
                        <td class="text-center text-muted small">${item.data_emissao ? new Date(item.data_emissao).toLocaleString('pt-BR') : '—'}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td><strong>${item.tipo || '—'}</strong></td>
                        <td>${item.grupo || '—'}</td>
                        <td>${item.ctes || 0}</td>
                        <td>${formatCurrency(item.valor || 0)}</td>
                        <td>${(item.peso || 0).toLocaleString()} kg</td>
                        <td>${item.volume || 0}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        initFiltros();
        carregarDados();
        setInterval(carregarDados, 60000);
    })();

    // Navegação dinâmica
    function showContent(id) {
        document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-submenu .nav-link').forEach(link => link.classList.remove('active'));
        const link = document.querySelector(`.nav-submenu .nav-link[onclick="showContent('${id}')"]`);
        if (link) link.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date().toLocaleDateString('pt-BR');
        document.querySelectorAll('[id^="current-date"]').forEach(el => el.textContent = now);
    });
</script>
{% endblock %}
